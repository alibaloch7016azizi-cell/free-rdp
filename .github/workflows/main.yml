name: Simple RDP for Laptop

on:
  workflow_dispatch:  # ÙÙ‚Ø· Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 Ø³Ø§Ø¹Øª

    steps:
    - name: Enable RDP
      run: |
        # ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
        
        # ØªÙ†Ø¸ÛŒÙ… Ø±Ù…Ø² Ù‚ÙˆÛŒ
        $password = ConvertTo-SecureString "LaptopRDP2024!" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $password
        
        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ (Ø¨Ø§ Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø¹Ø¶Ùˆ Ù†Ø¨Ø§Ø´Ù‡)
        try {
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member "runneradmin" -ErrorAction SilentlyContinue
            Write-Host "âœ… Added to Remote Desktop Users group"
        } catch {
            Write-Host "âš ï¸ Already member of Remote Desktop Users"
        }
        
        try {
            Add-LocalGroupMember -Group "Administrators" -Member "runneradmin" -ErrorAction SilentlyContinue
            Write-Host "âœ… Added to Administrators group"
        } catch {
            Write-Host "âš ï¸ Already member of Administrators"
        }

    - name: Setup CloudFlare Tunnel
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ cloudflared
        Write-Host "Downloading CloudFlare Tunnel..."
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"
        
        Write-Host "Starting tunnel..."
        Start-Process -FilePath "./cloudflared.exe" -ArgumentList "tunnel", "--url", "tcp://localhost:3389" -PassThru -RedirectStandardOutput "tunnel_output.txt"

    - name: Display Connection Info
      run: |
        Start-Sleep -Seconds 20
        
        Write-Host "===============================================" -ForegroundColor Green
        Write-Host "ğŸ–¥ï¸  RDP CONNECTION READY!" -ForegroundColor Yellow
        Write-Host "===============================================" -ForegroundColor Green
        Write-Host ""
        Write-Host "ğŸ“‹ Connection Details:" -ForegroundColor Cyan
        Write-Host "Username: runneradmin"
        Write-Host "Password: LaptopRDP2024!"
        Write-Host ""
        Write-Host "ğŸŒ Looking for tunnel URL in logs above..." -ForegroundColor Cyan
        Write-Host "Look for: 'https://xxx.trycloudflare.com'" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "â° Session will stay active for 6 hours" -ForegroundColor Magenta
        Write-Host "===============================================" -ForegroundColor Green
        
        # Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…
        Write-Host "ğŸ’» System Info:" -ForegroundColor Cyan
        Get-ComputerInfo | Select-Object WindowsProductName, TotalPhysicalMemory

    - name: Keep Alive
      run: |
        Write-Host "ğŸ”„ Keeping session alive..." -ForegroundColor Green
        
        for ($i = 1; $i -le 360; $i++) {
            Start-Sleep -Seconds 60
            
            if ($i % 15 -eq 0) {
                $timeLeft = 360 - $i
                Write-Host "â±ï¸  Session active - $timeLeft minutes remaining" -ForegroundColor Yellow
            }
            
            # Ù‡Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡ ÛŒØ¨Ø§Ø± Ú†Ú© Ú©Ù† tunnel Ù‡Ù†ÙˆØ² Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡
            if ($i % 30 -eq 0) {
                $processes = Get-Process cloudflared -ErrorAction SilentlyContinue
                if ($processes) {
                    Write-Host "âœ… Tunnel is running" -ForegroundColor Green
                } else {
                    Write-Host "âš ï¸ Tunnel might be down, restarting..." -ForegroundColor Red
                    Start-Process -FilePath "./cloudflared.exe" -ArgumentList "tunnel", "--url", "tcp://localhost:3389" -PassThru
                }
            }
        }
        
        Write-Host "â° Session ended after 6 hours" -ForegroundColor Red
